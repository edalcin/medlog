# Atualiza√ß√µes da Especifica√ß√£o - 2025-01-07

## üìù Resumo

Especifica√ß√£o atualizada com foco aprimorado no **evento central do sistema**: o registro da consulta m√©dica. Novas funcionalidades de cria√ß√£o r√°pida de profissionais, visualiza√ß√£o multi-perspectiva de arquivos e relat√≥rios detalhados foram adicionadas.

---

## üéØ Mudan√ßas Principais

### 1. Evento Central: Registro de Consulta M√©dica

**Anteriormente:** Processo padr√£o de CRUD
**Agora:** Fluxo otimizado e central do sistema

**Novo Fluxo:**
1. Data + Profissional (obrigat√≥rios)
2. Sele√ß√£o de profissional do pulldown (apenas ativos)
3. **NOVO:** Cria√ß√£o r√°pida de profissional (apenas nome)
4. Notas em texto livre com Markdown
5. Upload de arquivos (vinculados √† consulta E profissional)

**Documenta√ß√£o atualizada em:**
- `PRD.md` - Se√ß√£o "Funcionalidades"
- `.specify/inicioDesenv.md` - Nova se√ß√£o 4 completa
- `README.md` - Se√ß√£o "Funcionalidades" e "Uso do Sistema"

---

### 2. Cria√ß√£o R√°pida de Profissionais

**Problema:** Usu√°rio precisa de profissional no momento da consulta mas n√£o tem todos os dados

**Solu√ß√£o:**
- Campo de profissional aceita texto livre (combobox)
- Usu√°rio digita apenas o nome
- Sistema cria registro com `specialty = NULL`
- Posteriormente, usu√°rio completa dados na tela de edi√ß√£o

**Impacto no Schema:**
```sql
-- Campo specialty agora pode ser NULL
specialty VARCHAR(255),  -- Antes: NOT NULL

-- Novos campos para telefones e endere√ßo completo
phone_secondary VARCHAR(50),
city VARCHAR(100),
state VARCHAR(2),
```

**Novos Endpoints:**
- `POST /api/professionals/quick` - Cria√ß√£o r√°pida (apenas nome)
- `GET /api/professionals/active` - Lista apenas ativos para pulldown
- Query param `incomplete` em listagem - filtrar incompletos

**Documenta√ß√£o atualizada em:**
- `.specify/inicioDesenv.md` - Se√ß√£o 5.3
- `README.md` - Se√ß√£o "Uso do Sistema"

---

### 3. Status Ativo/Inativo de Profissionais

**Funcionalidade:**
- Campo `active` (BOOLEAN) controla visibilidade no pulldown
- Profissionais inativos:
  - N√£o aparecem em novas consultas
  - Permanecem no sistema (n√£o s√£o deletados)
  - Consultas antigas mant√™m refer√™ncia
- Podem ser reativados a qualquer momento

**Casos de Uso:**
- M√©dico se aposentou
- Profissional mudou de cidade
- N√£o atende mais por conv√™nio
- Temporariamente indispon√≠vel

**Novo Endpoint:**
- `PATCH /api/professionals/:id/status` - Ativar/desativar

**Documenta√ß√£o atualizada em:**
- `.specify/inicioDesenv.md` - Se√ß√£o 5.3.6
- `README.md` - Se√ß√£o "Gerenciar Profissionais"

---

### 4. Associa√ß√£o Dupla de Arquivos

**Mudan√ßa Cr√≠tica no Schema:**

**Antes:**
```sql
consultation_files
‚îú‚îÄ‚îÄ consultation_id (FK)
‚îî‚îÄ‚îÄ (outros campos)
```

**Agora:**
```sql
consultation_files
‚îú‚îÄ‚îÄ consultation_id (FK ‚Üí consultations)
‚îú‚îÄ‚îÄ professional_id (FK ‚Üí health_professionals) ‚≠ê NOVO
‚îî‚îÄ‚îÄ (outros campos)
```

**Vantagens:**
1. Buscar arquivos de uma consulta: `WHERE consultation_id = X`
2. Buscar arquivos de um profissional: `WHERE professional_id = Y`
3. Buscar por especialidade: `JOIN professionals WHERE specialty = Z`
4. Sem JOINs complexos para queries comuns
5. Performance melhorada

**Como Funciona:**
- No upload, `professional_id` √© copiado da consulta
- Se profissional mudar, arquivos mant√™m refer√™ncia original
- Desnormaliza√ß√£o intencional para performance

**Documenta√ß√£o atualizada em:**
- `.specify/inicioDesenv.md` - Se√ß√£o 3.1 (Schema) e 4.1.2
- `README.md` - Se√ß√£o "Estrutura do Banco de Dados"
- `.specify/decisions.md` - Decis√£o #14

---

### 5. Visualiza√ß√£o Multi-Perspectiva de Arquivos

**Nova Funcionalidade:** Tr√™s formas de visualizar arquivos

**Perspectiva 1: Por Consulta (padr√£o)**
- Endpoint: `GET /api/consultations/:consultation_id/files`
- Uso: Ver arquivos de uma consulta espec√≠fica
- Caso: "Quero ver os exames da minha √∫ltima consulta"

**Perspectiva 2: Por Profissional**
- Endpoint: `GET /api/professionals/:professional_id/files`
- Uso: Ver TODOS os arquivos de TODAS as consultas com aquele profissional
- Caso: "Quero ver todo o hist√≥rico de exames com meu cardiologista"
- Retorna: Arquivos de todas as consultas, ordenados por data

**Perspectiva 3: Por Especialidade**
- Endpoint: `GET /api/files/by-specialty?specialty=Cardiologia`
- Uso: Agrupar arquivos por √°rea m√©dica
- Caso: "Quero ver todos os exames cardiol√≥gicos que j√° fiz"
- Retorna: Arquivos de todos os profissionais daquela especialidade

**Documenta√ß√£o atualizada em:**
- `.specify/inicioDesenv.md` - Nova se√ß√£o 5.6 completa
- `README.md` - Nova se√ß√£o "Visualiza√ß√£o Multi-Perspectiva"
- `PRD.md` - Se√ß√£o "Visualiza√ß√£o de Documentos"
- `.specify/decisions.md` - Decis√£o #15

---

### 6. Relat√≥rios e An√°lises

**Nova Funcionalidade:** Quatro tipos de relat√≥rios

**Relat√≥rio 1: Consultas por Profissional**
- Endpoint: `GET /api/reports/consultations-by-professional`
- Retorna: Total de consultas, arquivos, √∫ltima consulta por profissional
- Uso: "Quantas vezes consultei com cada m√©dico?"

**Relat√≥rio 2: Consultas por Especialidade**
- Endpoint: `GET /api/reports/consultations-by-specialty`
- Retorna: Distribui√ß√£o de consultas por especialidade
- Uso: "Qual √°rea m√©dica eu mais visito?"

**Relat√≥rio 3: Consultas por Per√≠odo**
- Endpoint: `GET /api/reports/consultations-by-period`
- Query: `group_by=day/month/year`
- Retorna: Timeline de consultas agrupadas
- Uso: "Quantas consultas tive em 2024?"

**Relat√≥rio 4: Hist√≥rico Completo do Paciente**
- Endpoint: `GET /api/reports/patient-history/:user_id`
- Retorna: Resumo estat√≠stico completo
  - Total de consultas, arquivos, especialidades visitadas
  - Timeline de todo o hist√≥rico
  - Distribui√ß√£o por profissional e especialidade
- Uso: "Preciso do meu hist√≥rico completo para novo m√©dico"

**Documenta√ß√£o atualizada em:**
- `.specify/inicioDesenv.md` - Nova se√ß√£o 5.7 completa
- `README.md` - Nova se√ß√£o "Relat√≥rios e An√°lises"
- `PRD.md` - Se√ß√£o "Relat√≥rios"
- `.specify/decisions.md` - Decis√£o #16

---

## üìã Arquivos Atualizados

### Documenta√ß√£o Principal
1. ‚úÖ `PRD.md`
   - Se√ß√£o "Funcionalidades" reescrita
   - Adicionadas se√ß√µes de Visualiza√ß√£o e Relat√≥rios

2. ‚úÖ `.specify/inicioDesenv.md`
   - Nova se√ß√£o 4 completa: "Evento Central do Sistema"
   - Mockup textual da interface de registro
   - Se√ß√£o 5.3 expandida: Gest√£o de Profissionais
   - Nova se√ß√£o 5.6: Visualiza√ß√£o Multi-Perspectiva
   - Nova se√ß√£o 5.7: Relat√≥rios e An√°lises
   - Schema atualizado com novos campos

3. ‚úÖ `specs/main/plan.md`
   - Se√ß√£o "Core Features" reorganizada
   - Enfatizado evento central
   - Adicionadas features de visualiza√ß√£o e relat√≥rios

4. ‚úÖ `.specify/decisions.md`
   - Adicionadas decis√µes #8 a #17
   - Documentadas novas funcionalidades

5. ‚úÖ `README.md`
   - Se√ß√£o "Funcionalidades" completamente reescrita
   - Nova se√ß√£o "Uso do Sistema" com fluxos detalhados
   - Adicionada "Visualiza√ß√£o Multi-Perspectiva"
   - Adicionada "Relat√≥rios e An√°lises"
   - Schema do banco atualizado

---

## üîÑ Impacto no Desenvolvimento

### Fase 1 (Semana 1) - Inalterada
- Setup, autentica√ß√£o, layout b√°sico

### Fase 2 (Semana 2) - Ajustes
**Adicionar:**
- [ ] Implementar cria√ß√£o r√°pida de profissional
- [ ] Campo combobox com busca + texto livre
- [ ] Indicador visual de profissionais incompletos
- [ ] Status ativo/inativo em profissionais

### Fase 3 (Semana 3) - Expandida
**Adicionar:**
- [ ] Copiar professional_id no upload de arquivo
- [ ] Endpoints de visualiza√ß√£o multi-perspectiva:
  - [ ] Por consulta (j√° existia)
  - [ ] Por profissional (novo)
  - [ ] Por especialidade (novo)

### Fase 4 (Semana 4) - Expandida
**Adicionar:**
- [ ] Implementar 4 tipos de relat√≥rios:
  - [ ] Por profissional
  - [ ] Por especialidade
  - [ ] Por per√≠odo
  - [ ] Hist√≥rico completo
- [ ] Telas de visualiza√ß√£o de relat√≥rios
- [ ] Op√ß√£o de filtros em relat√≥rios

**Tempo estimado adicional:** +3-4 dias de desenvolvimento

---

## üìä Novos Endpoints

### Profissionais
```
POST   /api/professionals/quick          # Cria√ß√£o r√°pida
GET    /api/professionals/active         # Lista apenas ativos
PATCH  /api/professionals/:id/status    # Ativar/desativar
```

### Visualiza√ß√£o de Arquivos
```
GET    /api/consultations/:id/files               # Por consulta (j√° existia)
GET    /api/professionals/:id/files               # Por profissional (novo)
GET    /api/files/by-specialty?specialty=X        # Por especialidade (novo)
```

### Relat√≥rios
```
GET    /api/reports/consultations-by-professional  # Relat√≥rio 1
GET    /api/reports/consultations-by-specialty    # Relat√≥rio 2
GET    /api/reports/consultations-by-period       # Relat√≥rio 3
GET    /api/reports/patient-history/:user_id      # Relat√≥rio 4
```

---

## üóÑÔ∏è Altera√ß√µes no Schema

### Tabela: health_professionals
```sql
-- Campos modificados
specialty VARCHAR(255),  -- Agora pode ser NULL

-- Campos adicionados
phone_secondary VARCHAR(50),  -- Telefone adicional
city VARCHAR(100),            -- Cidade
state VARCHAR(2),             -- Estado (UF)

-- √çndice adicionado
INDEX idx_active (active)     -- Performance no pulldown
```

### Tabela: consultation_files
```sql
-- Campo adicionado
professional_id INT,  -- FK para health_professionals

-- Foreign key adicionada
FOREIGN KEY (professional_id) REFERENCES health_professionals(id) ON DELETE SET NULL,

-- √çndice adicionado
INDEX idx_professional (professional_id)  -- Performance nas queries
```

---

## ‚úÖ Checklist de Valida√ß√£o

### Documenta√ß√£o
- [x] PRD.md atualizado
- [x] Especifica√ß√£o t√©cnica atualizada
- [x] Plan.md atualizado
- [x] Decisions.md atualizado
- [x] README.md atualizado
- [x] Documento de atualiza√ß√µes criado

### Schema
- [x] Campo specialty pode ser NULL
- [x] Campos phone_secondary, city, state adicionados
- [x] Campo professional_id em consultation_files
- [x] √çndices atualizados

### Endpoints
- [x] Cria√ß√£o r√°pida documentada
- [x] Visualiza√ß√£o multi-perspectiva documentada
- [x] Relat√≥rios documentados

### UX
- [x] Fluxo de cria√ß√£o r√°pida documentado
- [x] Tr√™s formas de visualizar arquivos explicadas
- [x] Interface de relat√≥rios especificada

---

## üéØ Pr√≥ximos Passos

1. ‚úÖ Atualizar agent context (CLAUDE.md)
2. ‚è≥ Come√ßar Fase 1 do desenvolvimento
3. ‚è≥ Implementar schema atualizado no Prisma
4. ‚è≥ Criar migrations
5. ‚è≥ Implementar novos endpoints

---

**Data:** 2025-01-07  
**Status:** ‚úÖ Especifica√ß√£o atualizada e validada  
**Pr√≥xima a√ß√£o:** Executar update-agent-context.ps1
